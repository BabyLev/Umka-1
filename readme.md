# UMKA Server

### Краткое описание

Проект создавался изначально как тестовая работа для получения параметров спутника Umka-1, но затем перерос в веб-сервис, который позволяет работать с параметрами любого спутника. Проект, по крайней мере, двигается в эту сторону

### Дорожная карта (обновляется)

- [x] Добавить создание спутника через NORAD ID (добавить в схему данных). Если указаны обе линии и ID, то будет использоваться ID
- [x] Добавить запрос к API r4uab для получения актуальных данных
- [ ] Сделать кэш для хранения полученных данных. Обновлять раз в сутки


---

### Запуск

Чтобы запустить проект, нужно, чтобы на компьютере была версия Go не ниже, чем указанная в файле [go.mod](https://github.com/BabyLev/Umka-1/blob/main/go.mod)

TODO: сделать возможность выбора порта, на котором запускается веб сервер

По умолчанию, сервер запускается на `localhost:8080`

## Запуск приложения с использованием Docker

Для запуска всего приложения (бэкенд, фронтенд и база данных) с помощью Docker выполните следующие шаги:

1. Убедитесь, что у вас установлены Docker и Docker Compose.

2. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/yourusername/Umka-1.git
   cd Umka-1
   ```

3. Создайте файл `.env` на основе примера:
   ```bash
   cp .env.example .env
   ```
   
   Откройте файл `.env` и настройте переменные окружения под ваши требования. 
   Для использования Docker раскомментируйте соответствующие переменные.

4. Запустите приложение с помощью Docker Compose:
   ```bash
   docker-compose up -d
   ```

5. Приложение будет доступно по следующим адресам:
   - Фронтенд: http://localhost (или порт, указанный в FRONTEND_PORT)
   - API: http://localhost:8080 (или порт, указанный в HTTP_PORT)
   - База данных PostgreSQL: localhost:5432 (с учетными данными из переменных POSTGRES_USER и POSTGRES_PASSWORD)

### Разработка

Для локальной разработки фронтенда:

1. Перейдите в папку web:
   ```bash
   cd web
   ```

2. Установите зависимости:
   ```bash
   npm install
   ```

3. Запустите сервер разработки:
   ```bash
   npm run dev
   ```

### Сборка

Для ручной сборки фронтенда:

```bash
cd web
npm run build
```

Результат сборки будет доступен в директории `web/dist`.

## Документация API

### Общие объекты

#### `Location`

```json
{
  "lon": 0.0, // Долгота (градусы)
  "lat": 0.0, // Широта (градусы)
  "alt": 0.0  // Высота (км)
}
```

#### `ObserverLocation`

```json
{
  "name": "string",     // Название места наблюдения
  "location": Location // см. объект Location
}
```

#### `SatelliteInfo` (Используется в запросах/ответах для спутников)

```json
{
  "line1": "string", // Первая строка TLE
  "line2": "string", // Вторая строка TLE
  "name": "string",  // Имя спутника
  "noradId": 0     // NORAD ID (может быть null/отсутствовать)
}
```

---

### Расчеты параметров спутника

- #### `POST /calculate/`

  **Описание:** Возвращает рассчитанные координаты (широту, долготу, высоту) спутника для заданного времени и ссылку на Google Maps.

  **Запрос (`application/json`):**

  ```json
  {
    "satelliteId": 0, // ID спутника из хранилища
    "timestamp": 0    // Временная метка Unix (секунды), опционально. По умолчанию - текущее время.
  }
  ```

  **Ответ (`application/json`):**

  ```json
  {
    "lat": 0.0,        // Широта (градусы)
    "lon": 0.0,        // Долгота (градусы)
    "alt": 0.0,        // Высота (км)
    "gmapslink": "string" // Ссылка на Google Maps
  }
  ```

  **Пример запроса:**

  ```json
  {
    "satelliteId": 1,
    "timestamp": 1234567890
  }
  ```

  **Пример ответа:**

  ```json
  {
    "lat": -66.37755182682588,
    "lon": 46.50098627409187,
    "alt": 557.4210161450574,
    "gmapslink": "https://www.google.com/maps/place/-66.377552+46.500986"
  }
  ```

- #### `POST /look-angles/`

  **Описание:** Возвращает азимут, элевацию (угол места) и расстояние до спутника от заданной точки наблюдения в заданное время.

  **Запрос (`application/json`):**

  ```json
  {
    "satelliteId": 0,        // ID спутника из хранилища
    "timestamp": 0,          // Временная метка Unix (секунды), опционально. По умолчанию - текущее время.
    "observerPositionId": 0 // ID сохраненной локации наблюдателя
  }
  ```

  **Ответ (`application/json`):**

  ```json
  {
    "azimuth": 0.0,   // Азимут (градусы)
    "elevation": 0.0, // Элевация (угол места, градусы)
    "range": 0.0      // Расстояние (км)
  }
  ```

- #### `POST /time-ranges/`

  **Описание:** Рассчитывает и возвращает временные интервалы (начало и конец), когда спутник будет виден над заданной точкой наблюдения.

  **Запрос (`application/json`):**

  ```json
  {
    "satelliteId": 0,       // ID спутника из хранилища
    "timestamp": 0,         // Начальная временная метка Unix (секунды) для поиска, опционально. По умолчанию - текущее время.
    "lon": 0.0,             // Долгота точки наблюдения (градусы)
    "lat": 0.0,             // Широта точки наблюдения (градусы)
    "alt": 0.0,             // Высота точки наблюдения (км)
    "countOfTimeRanges": 0 // Количество искомых интервалов видимости, опционально. По умолчанию - 1.
  }
  ```

  **Ответ (`application/json`):** Массив объектов с интервалами видимости.

  ```json
  [
    {
      "start": "string", // Время начала видимости (RFC3339)
      "end": "string"    // Время конца видимости (RFC3339)
    }
  ]
  ```

---

### Управление спутниками

- #### `PUT /satellite/`

  **Описание:** Добавляет новый спутник в хранилище.
  - Если передан `noradId`, TLE данные (`line1`, `line2`) будут получены с `api.r4uab.ru` и перезапишут переданные в запросе.
  - Если `noradId` не передан, используются `line1` и `line2` из запроса.

  **Запрос (`application/json`):** Тело запроса соответствует объекту `SatelliteInfo`.

  ```json
  {
    "line1": "1 12345U 23091G   5555.99999  .00011108  00000", // Обязательно, если нет noradId
    "line2": "1 12345U 23091G   5555.99999  .00011108  00000", // Обязательно, если нет noradId
    "name": "Мой Спутник",                                // Обязательно
    "noradId": 12345                                       // Опционально
  }
  ```

  **Ответ (`application/json`):**

  ```json
  {
    "satelliteId": 0 // ID созданного спутника в хранилище
  }
  ```

  **Пример ответа:**

  ```json
  {
    "satelliteId": 1
  }
  ```

- #### `DELETE /satellite/{id}`

  **Описание:** Удаляет спутник из хранилища по его ID.

  **Параметры пути:**
  - `id`: ID спутника для удаления.

  **Ответ (`text/plain`):** Сообщение об успешном удалении.

  **Пример ответа:**
  ```
  спутник успешно удалился id = 1
  ```

- #### `POST /satellite/`

  **Описание:** Ищет и возвращает спутники из хранилища по заданным критериям (ID, NORAD ID, имя). Критерии поиска объединяются по "И".

  **Запрос (`application/json`):**

  ```json
  {
    "ids": [0],       // Массив ID спутников для поиска (опционально)
    "noradIds": [0], // Массив NORAD ID для поиска (опционально)
    "name": "string"  // Часть имени спутника для поиска (опционально)
  }
  ```
  **Пример запроса:**
  ```json
  {
    "name": "ISS"
  }
  ```

  **Ответ (`application/json`):** Карта найденных спутников, где ключ - ID спутника в хранилище, значение - объект `SatelliteInfo`.

  ```json
  {
    "satellites": {
      "1": { // ID спутника = 1
        "line1": "string",
        "line2": "string",
        "name": "string",
        "noradId": 0
      },
      "5": { // ID спутника = 5
         // ... объект SatelliteInfo ...
      }
    }
  }
  ```
   **Пример ответа:**
   ```json
   {
     "satellites": {
       "25544": {
         "line1": "1 25544U 98067A   24183.58373848  .00018876  00000+0  34701-3 0  9997",
         "line2": "2 25544  51.6418 101.3576 0006878  64.9182 295.2226 15.49597969458107",
         "name": "ISS (ZARYA)",
         "noradId": 25544
       }
     }
   }
   ```


- #### `GET /satellite/{id}`

  **Описание:** Возвращает информацию о спутнике по его ID в хранилище.

  **Параметры пути:**
  - `id`: ID спутника.

  **Ответ (`application/json`):** Объект `SatelliteInfo`.

  **Пример ответа:**
  ```json
  {
    "line1": "1 25544U 98067A   24183.58373848  .00018876  00000+0  34701-3 0  9997",
    "line2": "2 25544  51.6418 101.3576 0006878  64.9182 295.2226 15.49597969458107",
    "name": "ISS (ZARYA)",
    "noradId": 25544
  }
  ```

- #### `PATCH /satellite/`

  **Описание:** Обновляет данные существующего спутника в хранилище.
  - Если в запросе передан `noradId`, он будет обновлен, а также будут обновлены `line1`, `line2` и `name` на основе данных с `api.r4uab.ru` для этого `noradId`. Переданные в запросе `line1`, `line2`, `name` будут проигнорированы.
  - Если `noradId` не передан (или `null`), обновляются только те поля (`line1`, `line2`, `name`), которые переданы в запросе. `noradId` спутника не изменяется.

  **Запрос (`application/json`):**

  ```json
  {
    "satelliteId": 0,     // ID спутника для обновления (обязательно)
    "satellite": {        // Объект SatelliteInfo с новыми данными
      "line1": "string",   // Новые данные (опционально, если не передан noradId)
      "line2": "string",   // Новые данные (опционально, если не передан noradId)
      "name": "string",    // Новые данные (опционально, если не передан noradId)
      "noradId": 0       // Новый NORAD ID (опционально)
    }
  }
  ```

  **Пример запроса (обновление имени):**

  ```json
  {
    "satelliteId": 5,
    "satellite": {
      "name": "Новое Имя Спутника"
    }
  }
  ```
  **Пример запроса (обновление по NORAD ID):**
  ```json
  {
    "satelliteId": 5,
    "satellite": {
      "noradId": 55098 // Обновит NORAD ID, line1, line2, name по данным с r4uab
    }
  }
  ```

  **Ответ:**
  - `200 OK` в случае успеха.
  - Ошибка `4xx` или `5xx` в случае неудачи.

---

### Управление локациями наблюдателя

- #### `PUT /location/`

  **Описание:** Добавляет новую локацию наблюдателя в хранилище.

  **Запрос (`application/json`):** Тело запроса соответствует объекту `ObserverLocation`.

  ```json
  {
    "name": "Моя Точка",
    "location": {
      "lon": 37.6173,
      "lat": 55.7558,
      "alt": 0.15
    }
  }
  ```

  **Ответ (`application/json`):**

  ```json
  {
    "observerLocationId": 0 // ID созданной локации
  }
  ```

- #### `DELETE /location/{id}`

  **Описание:** Удаляет локацию наблюдателя из хранилища по ее ID.

  **Параметры пути:**
  - `id`: ID локации для удаления.

  **Ответ (`text/plain`):** Сообщение об успешном удалении.

  **Пример ответа:**
  ```
  локация успешно удалилась id = 1
  ```

- #### `POST /location/`

  **Описание:** Ищет и возвращает локации наблюдателя по имени.

  **Запрос (`application/json`):**

  ```json
  {
    "name": "string" // Имя или часть имени локации для поиска
  }
  ```

  **Ответ (`application/json`):** Карта найденных локаций, где ключ - ID локации в хранилище, значение - объект `ObserverLocation`.

  ```json
  {
    "locations": {
      "1": { // ID локации = 1
        "name": "string",
        "location": {
          "lon": 0.0,
          "lat": 0.0,
          "alt": 0.0
        }
      },
      "3": { // ID локации = 3
        // ... объект ObserverLocation ...
      }
    }
  }
  ```

- #### `PATCH /location/`

  **Описание:** Обновляет данные существующей локации наблюдателя.

  **Запрос (`application/json`):**

  ```json
  {
    "locationId": 0,     // ID локации для обновления (обязательно)
    "location": {        // Объект ObserverLocation с новыми данными
      "name": "string",   // Новое имя (обязательно)
      "location": {      // Новый объект Location (обязательно)
         "lon": 0.0,
         "lat": 0.0,
         "alt": 0.0
       }
    }
  }
  ```

  **Ответ:**
  - `200 OK` в случае успеха.
  - Ошибка `4xx` или `5xx` в случае неудачи.
